# Development Dockerfile with hot reloading

FROM node:22-alpine AS base
RUN apk add --no-cache libc6-compat
RUN corepack enable && corepack prepare pnpm@8.15.5 --activate

# Create non-root user to avoid permission issues
RUN addgroup -g 1001 nodejs && \
    adduser -D -u 1001 -G nodejs nodejs

WORKDIR /app
RUN chown -R nodejs:nodejs /app

# Install dependencies
FROM base AS deps
USER nodejs
COPY --chown=nodejs:nodejs package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY --chown=nodejs:nodejs apps/api/package.json ./apps/api/
COPY --chown=nodejs:nodejs apps/web/package.json ./apps/web/
COPY --chown=nodejs:nodejs packages/ ./packages/
RUN pnpm install

# API Development
FROM base AS api-dev
USER nodejs
COPY --from=deps --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --chown=nodejs:nodejs . .
EXPOSE 3000
CMD ["pnpm", "--filter", "api", "dev"]

# Web Development - Vite dev server
FROM base AS web-dev
USER nodejs
COPY --from=deps --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --chown=nodejs:nodejs . .
EXPOSE 5173
CMD ["pnpm", "--filter", "web", "dev"]